# yaml-language-server: $schema=https://json.schemastore.org/any.json
# Test scenarios for azure-ai-anomalydetector-java skill evaluation
# Each scenario tests a specific usage pattern against acceptance criteria

config:
  model: gpt-4
  max_tokens: 2000
  temperature: 0.3

scenarios:
  # Client Setup
  - name: client_creation_api_key
    prompt: |
      Create Java code to set up the Azure AI Anomaly Detector clients using
      API key authentication. Create both UnivariateClient and MultivariateClient.
    expected_patterns:
      - "AnomalyDetectorClientBuilder"
      - "AzureKeyCredential"
      - "buildUnivariateClient"
      - "buildMultivariateClient"
      - 'System\.getenv\('
    forbidden_patterns:
      - 'endpoint\("https://'  # Hardcoded endpoint
      - 'AzureKeyCredential\("'  # Hardcoded key
    tags:
      - basic
      - authentication
      - client
    mock_response: |
      import com.azure.ai.anomalydetector.AnomalyDetectorClientBuilder;
      import com.azure.ai.anomalydetector.MultivariateClient;
      import com.azure.ai.anomalydetector.UnivariateClient;
      import com.azure.core.credential.AzureKeyCredential;

      public class ClientSetup {
          public static void main(String[] args) {
              String endpoint = System.getenv("AZURE_ANOMALY_DETECTOR_ENDPOINT");
              String key = System.getenv("AZURE_ANOMALY_DETECTOR_API_KEY");
              
              UnivariateClient univariateClient = new AnomalyDetectorClientBuilder()
                  .credential(new AzureKeyCredential(key))
                  .endpoint(endpoint)
                  .buildUnivariateClient();
              
              MultivariateClient multivariateClient = new AnomalyDetectorClientBuilder()
                  .credential(new AzureKeyCredential(key))
                  .endpoint(endpoint)
                  .buildMultivariateClient();
              
              System.out.println("Clients initialized successfully");
          }
      }

  # Univariate Detection
  - name: univariate_batch_detection
    prompt: |
      Create a Java example that performs univariate batch anomaly detection
      on a time series. Include creating TimeSeriesPoint data and configuring
      detection options with granularity and sensitivity.
    expected_patterns:
      - "TimeSeriesPoint"
      - "UnivariateDetectionOptions"
      - "detectUnivariateEntireSeries"
      - "UnivariateEntireDetectionResult"
      - "getIsAnomaly"
      - "TimeGranularity"
    forbidden_patterns:
      - "new AnomalyDetectorClient("  # Wrong: use UnivariateClient or MultivariateClient
    tags:
      - univariate
      - detection
      - basic
    mock_response: |
      import com.azure.ai.anomalydetector.AnomalyDetectorClientBuilder;
      import com.azure.ai.anomalydetector.UnivariateClient;
      import com.azure.ai.anomalydetector.models.*;
      import com.azure.core.credential.AzureKeyCredential;
      import java.time.OffsetDateTime;
      import java.util.List;

      public class UnivariateBatchDetection {
          public static void main(String[] args) {
              String endpoint = System.getenv("AZURE_ANOMALY_DETECTOR_ENDPOINT");
              String key = System.getenv("AZURE_ANOMALY_DETECTOR_API_KEY");
              
              UnivariateClient client = new AnomalyDetectorClientBuilder()
                  .credential(new AzureKeyCredential(key))
                  .endpoint(endpoint)
                  .buildUnivariateClient();
              
              List<TimeSeriesPoint> series = List.of(
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-01T00:00:00Z"), 826.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-02T00:00:00Z"), 799.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-03T00:00:00Z"), 890.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-04T00:00:00Z"), 900.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-05T00:00:00Z"), 961.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-06T00:00:00Z"), 935.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-07T00:00:00Z"), 894.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-08T00:00:00Z"), 855.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-09T00:00:00Z"), 809.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-10T00:00:00Z"), 810.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-11T00:00:00Z"), 766.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-12T00:00:00Z"), 805.0),
                  new TimeSeriesPoint(OffsetDateTime.parse("2023-01-13T00:00:00Z"), 2000.0)
              );
              
              UnivariateDetectionOptions options = new UnivariateDetectionOptions(series)
                  .setGranularity(TimeGranularity.DAILY)
                  .setSensitivity(95);
              
              UnivariateEntireDetectionResult result = client.detectUnivariateEntireSeries(options);
              
              for (int i = 0; i < result.getIsAnomaly().size(); i++) {
                  if (result.getIsAnomaly().get(i)) {
                      System.out.printf("Anomaly at index %d with value %.2f%n",
                          i, series.get(i).getValue());
                  }
              }
          }
      }

  # Last Point Detection
  - name: univariate_last_point_detection
    prompt: |
      Create a Java example that performs last point (streaming) anomaly detection.
      This is useful for real-time anomaly detection on the most recent data point.
    expected_patterns:
      - "UnivariateDetectionOptions"
      - "detectUnivariateLastPoint"
      - "UnivariateLastDetectionResult"
      - "isAnomaly"
      - "getExpectedValue"
    tags:
      - univariate
      - streaming
      - real-time
    mock_response: |
      import com.azure.ai.anomalydetector.AnomalyDetectorClientBuilder;
      import com.azure.ai.anomalydetector.UnivariateClient;
      import com.azure.ai.anomalydetector.models.*;
      import com.azure.core.credential.AzureKeyCredential;
      import java.time.OffsetDateTime;
      import java.util.ArrayList;
      import java.util.List;

      public class LastPointDetection {
          public static void main(String[] args) {
              String endpoint = System.getenv("AZURE_ANOMALY_DETECTOR_ENDPOINT");
              String key = System.getenv("AZURE_ANOMALY_DETECTOR_API_KEY");
              
              UnivariateClient client = new AnomalyDetectorClientBuilder()
                  .credential(new AzureKeyCredential(key))
                  .endpoint(endpoint)
                  .buildUnivariateClient();
              
              List<TimeSeriesPoint> series = new ArrayList<>();
              // Add at least 12 historical points plus the point to check
              for (int i = 0; i < 15; i++) {
                  series.add(new TimeSeriesPoint(
                      OffsetDateTime.now().minusDays(15 - i),
                      100 + Math.random() * 20
                  ));
              }
              
              UnivariateDetectionOptions options = new UnivariateDetectionOptions(series)
                  .setGranularity(TimeGranularity.DAILY)
                  .setSensitivity(95);
              
              UnivariateLastDetectionResult result = client.detectUnivariateLastPoint(options);
              
              System.out.println("Is Anomaly: " + result.isAnomaly());
              System.out.printf("Expected Value: %.2f%n", result.getExpectedValue());
              System.out.printf("Upper Margin: %.2f%n", result.getUpperMargin());
              System.out.printf("Lower Margin: %.2f%n", result.getLowerMargin());
              
              if (result.isAnomaly()) {
                  System.out.println("⚠️ ALERT: Latest data point is an anomaly!");
              }
          }
      }

  # Change Point Detection
  - name: change_point_detection
    prompt: |
      Create a Java example that detects change points (trend changes) in a time series.
    expected_patterns:
      - "UnivariateChangePointDetectionOptions"
      - "detectUnivariateChangePoint"
      - "UnivariateChangePointDetectionResult"
      - "getIsChangePoint"
      - "getConfidenceScores"
    tags:
      - univariate
      - change-point
    mock_response: |
      import com.azure.ai.anomalydetector.AnomalyDetectorClientBuilder;
      import com.azure.ai.anomalydetector.UnivariateClient;
      import com.azure.ai.anomalydetector.models.*;
      import com.azure.core.credential.AzureKeyCredential;
      import java.time.OffsetDateTime;
      import java.util.List;

      public class ChangePointDetection {
          public static void main(String[] args) {
              String endpoint = System.getenv("AZURE_ANOMALY_DETECTOR_ENDPOINT");
              String key = System.getenv("AZURE_ANOMALY_DETECTOR_API_KEY");
              
              UnivariateClient client = new AnomalyDetectorClientBuilder()
                  .credential(new AzureKeyCredential(key))
                  .endpoint(endpoint)
                  .buildUnivariateClient();
              
              List<TimeSeriesPoint> series = createTimeSeries();
              
              UnivariateChangePointDetectionOptions options = 
                  new UnivariateChangePointDetectionOptions(series, TimeGranularity.DAILY);
              
              UnivariateChangePointDetectionResult result = 
                  client.detectUnivariateChangePoint(options);
              
              System.out.println("Period: " + result.getPeriod());
              
              for (int i = 0; i < result.getIsChangePoint().size(); i++) {
                  if (result.getIsChangePoint().get(i)) {
                      System.out.printf("Change point at index %d (confidence: %.2f)%n",
                          i, result.getConfidenceScores().get(i));
                  }
              }
          }
          
          private static List<TimeSeriesPoint> createTimeSeries() {
              // Create sample time series with at least 12 points
              return List.of(/* ... time series data ... */);
          }
      }

  # Multivariate Model Training
  - name: multivariate_model_training
    prompt: |
      Create a Java example that trains a multivariate anomaly detection model
      using data from Azure Blob Storage. Include model info configuration.
    expected_patterns:
      - "ModelInfo"
      - "trainMultivariateModel"
      - "AnomalyDetectionModel"
      - "getModelId"
      - "setDataSource"
      - "setSlidingWindow"
    tags:
      - multivariate
      - training
    mock_response: |
      import com.azure.ai.anomalydetector.AnomalyDetectorClientBuilder;
      import com.azure.ai.anomalydetector.MultivariateClient;
      import com.azure.ai.anomalydetector.models.*;
      import com.azure.core.credential.AzureKeyCredential;
      import java.time.OffsetDateTime;

      public class MultivariateTraining {
          public static void main(String[] args) {
              String endpoint = System.getenv("AZURE_ANOMALY_DETECTOR_ENDPOINT");
              String key = System.getenv("AZURE_ANOMALY_DETECTOR_API_KEY");
              
              MultivariateClient client = new AnomalyDetectorClientBuilder()
                  .credential(new AzureKeyCredential(key))
                  .endpoint(endpoint)
                  .buildMultivariateClient();
              
              String blobSasUrl = System.getenv("TRAINING_DATA_URL");
              
              ModelInfo modelInfo = new ModelInfo()
                  .setDataSource(blobSasUrl)
                  .setStartTime(OffsetDateTime.parse("2023-01-01T00:00:00Z"))
                  .setEndTime(OffsetDateTime.parse("2023-06-01T00:00:00Z"))
                  .setSlidingWindow(200)
                  .setDisplayName("MyMultivariateModel");
              
              AnomalyDetectionModel model = client.trainMultivariateModel(modelInfo);
              
              String modelId = model.getModelId();
              System.out.println("Model ID: " + modelId);
              
              // Check training status
              AnomalyDetectionModel trainedModel = client.getMultivariateModel(modelId);
              System.out.println("Status: " + trainedModel.getModelInfo().getStatus());
          }
      }

  # Error Handling
  - name: error_handling
    prompt: |
      Create a Java example showing proper error handling for anomaly detection operations.
      Handle HttpResponseException and print appropriate error messages.
    expected_patterns:
      - "HttpResponseException"
      - "try"
      - "catch"
      - "getResponse().getStatusCode()"
      - "getMessage()"
    forbidden_patterns:
      - "catch (Exception e) {}"  # Empty catch
      - "catch (Exception e) { }"
    tags:
      - error-handling
    mock_response: |
      import com.azure.ai.anomalydetector.AnomalyDetectorClientBuilder;
      import com.azure.ai.anomalydetector.UnivariateClient;
      import com.azure.ai.anomalydetector.models.*;
      import com.azure.core.credential.AzureKeyCredential;
      import com.azure.core.exception.HttpResponseException;
      import java.util.List;

      public class ErrorHandlingExample {
          public static void main(String[] args) {
              String endpoint = System.getenv("AZURE_ANOMALY_DETECTOR_ENDPOINT");
              String key = System.getenv("AZURE_ANOMALY_DETECTOR_API_KEY");
              
              UnivariateClient client = new AnomalyDetectorClientBuilder()
                  .credential(new AzureKeyCredential(key))
                  .endpoint(endpoint)
                  .buildUnivariateClient();
              
              try {
                  List<TimeSeriesPoint> series = createTimeSeries();
                  UnivariateDetectionOptions options = new UnivariateDetectionOptions(series)
                      .setGranularity(TimeGranularity.DAILY);
                  
                  UnivariateEntireDetectionResult result = 
                      client.detectUnivariateEntireSeries(options);
                  
                  System.out.println("Detection completed successfully");
                  
              } catch (HttpResponseException e) {
                  int statusCode = e.getResponse().getStatusCode();
                  System.err.println("HTTP Status: " + statusCode);
                  System.err.println("Error: " + e.getMessage());
                  
                  switch (statusCode) {
                      case 400:
                          System.err.println("Bad request - check data format (minimum 12 points)");
                          break;
                      case 401:
                          System.err.println("Unauthorized - check API key");
                          break;
                      case 429:
                          System.err.println("Rate limited - implement retry with backoff");
                          break;
                      default:
                          System.err.println("Unexpected error");
                  }
              }
          }
          
          private static List<TimeSeriesPoint> createTimeSeries() {
              return List.of(/* ... */);
          }
      }

  # Async Client
  - name: async_client_usage
    prompt: |
      Create a Java example using the async client (UnivariateAsyncClient)
      for anomaly detection. Use reactive patterns with subscribe.
    expected_patterns:
      - "UnivariateAsyncClient"
      - "buildUnivariateAsyncClient"
      - "subscribe"
    tags:
      - async
      - advanced
    mock_response: |
      import com.azure.ai.anomalydetector.AnomalyDetectorClientBuilder;
      import com.azure.ai.anomalydetector.UnivariateAsyncClient;
      import com.azure.ai.anomalydetector.models.*;
      import com.azure.core.credential.AzureKeyCredential;
      import java.time.OffsetDateTime;
      import java.util.List;

      public class AsyncDetection {
          public static void main(String[] args) throws InterruptedException {
              String endpoint = System.getenv("AZURE_ANOMALY_DETECTOR_ENDPOINT");
              String key = System.getenv("AZURE_ANOMALY_DETECTOR_API_KEY");
              
              UnivariateAsyncClient asyncClient = new AnomalyDetectorClientBuilder()
                  .credential(new AzureKeyCredential(key))
                  .endpoint(endpoint)
                  .buildUnivariateAsyncClient();
              
              List<TimeSeriesPoint> series = createTimeSeries();
              UnivariateDetectionOptions options = new UnivariateDetectionOptions(series)
                  .setGranularity(TimeGranularity.DAILY)
                  .setSensitivity(95);
              
              asyncClient.detectUnivariateEntireSeries(options)
                  .subscribe(
                      result -> {
                          System.out.println("Detection completed");
                          for (int i = 0; i < result.getIsAnomaly().size(); i++) {
                              if (result.getIsAnomaly().get(i)) {
                                  System.out.printf("Anomaly at index %d%n", i);
                              }
                          }
                      },
                      error -> System.err.println("Error: " + error.getMessage()),
                      () -> System.out.println("Operation completed")
                  );
              
              // Keep main thread alive for demo
              Thread.sleep(5000);
          }
          
          private static List<TimeSeriesPoint> createTimeSeries() {
              return List.of(/* ... at least 12 points ... */);
          }
      }
