# Test scenarios for azd-deployment skill evaluation
# Each scenario tests a specific Azure Developer CLI pattern against acceptance criteria

config:
  model: gpt-4
  max_tokens: 2000
  temperature: 0.3

scenarios:
  # Basic azure.yaml Configuration
  - name: basic_azure_yaml
    prompt: |
      Create an azure.yaml configuration file for deploying a Python FastAPI 
      backend service to Azure Container Apps using azd. Include proper
      remote build configuration for cross-platform compatibility.
    expected_patterns:
      - "name:"
      - "services:"
      - "host: containerapp"
      - "language: python"
      - "remoteBuild: true"
      - "docker:"
      - "path:"
    forbidden_patterns:
      - "host: appservice"
      - "host: function"
    tags:
      - basic
      - azure-yaml
    mock_response: |
      name: my-fastapi-app
      services:
        backend:
          project: ./src/backend
          language: python
          host: containerapp
          docker:
            path: ./Dockerfile
            context: .
            remoteBuild: true

  # Multi-Service Configuration
  - name: multi_service_azure_yaml
    prompt: |
      Create an azure.yaml configuration for a full-stack application with:
      - A React TypeScript frontend
      - A Python FastAPI backend
      Both should deploy to Container Apps with remote builds.
      Include proper hooks for post-deployment logging.
    expected_patterns:
      - "frontend:"
      - "backend:"
      - "language: ts"
      - "language: python"
      - "remoteBuild: true"
      - "hooks:"
      - "postdeploy:"
    forbidden_patterns:
      - "remoteBuild: false"
      - "host: appservice"
    tags:
      - multi-service
      - hooks
    mock_response: |
      name: fullstack-app
      metadata:
        template: fullstack@1.0.0

      infra:
        provider: bicep
        path: ./infra

      services:
        frontend:
          project: ./src/frontend
          language: ts
          host: containerapp
          docker:
            path: ./Dockerfile
            context: .
            remoteBuild: true

        backend:
          project: ./src/backend
          language: python
          host: containerapp
          docker:
            path: ./Dockerfile
            context: .
            remoteBuild: true

      hooks:
        postdeploy:
          shell: sh
          run: |
            echo "Frontend: ${SERVICE_FRONTEND_URI}"
            echo "Backend: ${SERVICE_BACKEND_URI}"

  # Bicep Container App Module
  - name: bicep_container_app
    prompt: |
      Create a Bicep module for an Azure Container App that:
      - Uses system-assigned managed identity
      - Configures external ingress on port 8000
      - Uses managed identity for ACR authentication
      - Includes the azd-service-name tag for discovery
      - Outputs the URI and principal ID
    expected_patterns:
      - "Microsoft.App/containerApps"
      - "type: 'SystemAssigned'"
      - "azd-service-name"
      - "ingress:"
      - "external: true"
      - "targetPort:"
      - "identity: 'system'"
      - "output.*uri"
      - "output.*principalId"
    forbidden_patterns:
      - "username:"
      - "passwordSecretRef:"
      - "type: 'None'"
    tags:
      - bicep
      - container-app
      - managed-identity
    mock_response: |
      param containerAppName string
      param location string
      param containerAppEnvironmentId string
      param containerRegistryLoginServer string
      param imageName string
      param serviceName string
      param envVars array = []

      resource containerApp 'Microsoft.App/containerApps@2024-03-01' = {
        name: containerAppName
        location: location
        tags: {
          'azd-service-name': serviceName
        }
        identity: {
          type: 'SystemAssigned'
        }
        properties: {
          environmentId: containerAppEnvironmentId
          configuration: {
            ingress: {
              external: true
              targetPort: 8000
            }
            registries: [
              {
                server: containerRegistryLoginServer
                identity: 'system'
              }
            ]
          }
          template: {
            containers: [
              {
                name: containerAppName
                image: imageName
                resources: {
                  cpu: json('0.5')
                  memory: '1Gi'
                }
                env: envVars
              }
            ]
          }
        }
      }

      output uri string = 'https://${containerApp.properties.configuration.ingress.fqdn}'
      output principalId string = containerApp.identity.principalId

  # Parameter Injection
  - name: bicep_parameters_json
    prompt: |
      Create a main.parameters.json file for Bicep that:
      - Injects AZURE_ENV_NAME for environment name
      - Has AZURE_LOCATION with a default of eastus2
      - Includes AZURE_OPENAI_ENDPOINT for AI services
      Use the proper azd environment variable syntax.
    expected_patterns:
      - "\\$schema"
      - "parameters"
      - "\\$\\{AZURE_ENV_NAME\\}"
      - "\\$\\{AZURE_LOCATION"
      - "\\$\\{AZURE_OPENAI_ENDPOINT\\}"
    forbidden_patterns:
      - "https://my-openai"
      - "\"eastus\""  # Should use ${} syntax, not hardcoded string
    tags:
      - bicep
      - parameters
    mock_response: |
      {
        "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentParameters.json#",
        "contentVersion": "1.0.0.0",
        "parameters": {
          "environmentName": { "value": "${AZURE_ENV_NAME}" },
          "location": { "value": "${AZURE_LOCATION=eastus2}" },
          "azureOpenAiEndpoint": { "value": "${AZURE_OPENAI_ENDPOINT}" }
        }
      }

  # Post-Provision RBAC Hook
  - name: rbac_hook
    prompt: |
      Create an azure.yaml hooks section that:
      - Runs after provisioning
      - Assigns the Cognitive Services OpenAI User role to the backend
      - Uses the BACKEND_PRINCIPAL_ID from Bicep outputs
      - Handles "already exists" errors gracefully
    expected_patterns:
      - "postprovision:"
      - "shell: sh"
      - "az role assignment create"
      - "assignee-object-id"
      - "Cognitive Services OpenAI User"
      - "\\|\\| true"
    forbidden_patterns:
      - "assignee:"  # Should use assignee-object-id
    tags:
      - hooks
      - rbac
    mock_response: |
      hooks:
        postprovision:
          shell: sh
          run: |
            PRINCIPAL_ID="${BACKEND_PRINCIPAL_ID}"
            
            # Assign Azure OpenAI access to backend
            az role assignment create \
              --assignee-object-id "$PRINCIPAL_ID" \
              --assignee-principal-type ServicePrincipal \
              --role "Cognitive Services OpenAI User" \
              --scope "$OPENAI_RESOURCE_ID" 2>/dev/null || true
            
            echo "RBAC assignment completed for backend service"

  # Environment Setup Commands
  - name: azd_environment_setup
    prompt: |
      Write the Azure Developer CLI commands to:
      1. Login to Azure
      2. Initialize a new azd project
      3. Create a new environment called "dev"
      4. Set Azure OpenAI endpoint
      5. Deploy everything
    expected_patterns:
      - "azd auth login"
      - "azd init"
      - "azd env new"
      - "azd env set"
      - "azd up"
    forbidden_patterns:
      - "az login"
      - "az containerapp"
    tags:
      - commands
      - setup
    mock_response: |
      # Login to Azure
      azd auth login
      
      # Initialize azd project (creates azure.yaml if not exists)
      azd init
      
      # Create development environment
      azd env new dev
      
      # Configure environment variables
      azd env set AZURE_OPENAI_ENDPOINT "https://my-openai.openai.azure.com"
      azd env set AZURE_SEARCH_ENDPOINT "https://my-search.search.windows.net"
      
      # Deploy infrastructure and code
      azd up

  # Service Discovery
  - name: internal_service_discovery
    prompt: |
      Create a Bicep snippet showing how to configure a frontend Container App
      to communicate with a backend Container App using internal DNS.
      The backend service name follows the pattern ca-backend-{resourceToken}.
    expected_patterns:
      - "env:"
      - "BACKEND_URL"
      - "http://ca-backend"
      - "resourceToken"
    forbidden_patterns:
      - "https://.*azurecontainerapps.io"
      - "https://ca-backend"
    tags:
      - service-discovery
      - bicep
    mock_response: |
      param resourceToken string

      resource frontend 'Microsoft.App/containerApps@2024-03-01' = {
        name: 'ca-frontend-${resourceToken}'
        // ... other config
        properties: {
          // ... other properties
          template: {
            containers: [
              {
                name: 'frontend'
                image: frontendImage
                env: [
                  {
                    name: 'BACKEND_URL'
                    value: 'http://ca-backend-${resourceToken}'
                  }
                ]
              }
            ]
          }
        }
      }

  # Bicep Outputs
  - name: bicep_outputs
    prompt: |
      Create Bicep outputs for a main.bicep file that exports:
      - Frontend and backend URIs
      - Backend principal ID for RBAC
      These outputs should auto-populate the azd environment.
    expected_patterns:
      - "output SERVICE_FRONTEND_URI"
      - "output SERVICE_BACKEND_URI"
      - "output BACKEND_PRINCIPAL_ID"
      - "string"
    tags:
      - bicep
      - outputs
    mock_response: |
      // Outputs auto-populate .azure/<env>/.env
      output SERVICE_FRONTEND_URI string = frontend.outputs.uri
      output SERVICE_BACKEND_URI string = backend.outputs.uri
      output BACKEND_PRINCIPAL_ID string = backend.outputs.principalId
      output AZURE_CONTAINER_REGISTRY_ENDPOINT string = containerRegistry.properties.loginServer
