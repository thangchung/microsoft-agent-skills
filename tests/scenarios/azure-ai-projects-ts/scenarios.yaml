# yaml-language-server: $schema=../skill-scenarios.schema.json
# Test scenarios for azure-ai-projects-ts skill evaluation
# Each scenario tests a specific usage pattern against acceptance criteria

config:
  model: gpt-4
  max_tokens: 2000
  temperature: 0.3

scenarios:
  # Basic Client Creation
  - name: basic_project_client
    prompt: |
      Create a basic Azure AI Projects client in TypeScript with
      DefaultAzureCredential authentication.
    expected_patterns:
      - "AIProjectClient"
      - "DefaultAzureCredential"
      - "new AIProjectClient"
      - "process.env"
    forbidden_patterns:
      - "from azure.ai.projects"
      - "AgentsClient"
    tags:
      - basic
      - authentication
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const client = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());

      console.log("Project client created successfully");

  # Get OpenAI Client
  - name: get_openai_client
    prompt: |
      Create a TypeScript example that gets an OpenAI client from the
      AIProjectClient and makes a simple response request.
    expected_patterns:
      - "getOpenAIClient"
      - "responses.create"
      - "output_text"
    tags:
      - openai
      - responses
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const deploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());

      const openAIClient = await project.getOpenAIClient();

      const response = await openAIClient.responses.create({
        model: deploymentName,
        input: "What is the capital of France?",
      });

      console.log(response.output_text);

  # Create Versioned Agent
  - name: create_versioned_agent
    prompt: |
      Create a versioned agent in TypeScript using the AIProjectClient's
      agents.createVersion method with prompt kind.
    expected_patterns:
      - "agents.createVersion"
      - 'kind: "prompt"'
      - "agent.id"
      - "agent.name"
      - "agent.version"
    tags:
      - agents
      - versioning
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const deploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());

      const agent = await project.agents.createVersion("my-agent-basic", {
        kind: "prompt",
        model: deploymentName,
        instructions: "You are a helpful assistant that answers general questions",
      });

      console.log(`Agent created (id: ${agent.id}, name: ${agent.name}, version: ${agent.version})`);

  # Agent with Conversation
  - name: agent_with_conversation
    prompt: |
      Create a TypeScript example that creates an agent and uses it with
      a conversation through the OpenAI client.
    expected_patterns:
      - "agents.createVersion"
      - "conversations.create"
      - "responses.create"
      - "agent_reference"
      - "conversation.id"
    tags:
      - agents
      - conversations
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const deploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());
      const openAIClient = await project.getOpenAIClient();

      // Create agent
      const agent = await project.agents.createVersion("conversation-agent", {
        kind: "prompt",
        model: deploymentName,
        instructions: "You are a helpful assistant",
      });

      // Create conversation with initial message
      const conversation = await openAIClient.conversations.create({
        items: [
          { type: "message", role: "user", content: "What is the size of France?" },
        ],
      });

      // Generate response using agent
      const response = await openAIClient.responses.create(
        {
          conversation: conversation.id,
        },
        {
          body: { agent: { name: agent.name, type: "agent_reference" } },
        },
      );

      console.log(`Response: ${response.output_text}`);

      // Add follow-up message
      await openAIClient.conversations.items.create(conversation.id, {
        items: [
          { type: "message", role: "user", content: "And what is the capital?" },
        ],
      });

      // Get follow-up response
      const followUp = await openAIClient.responses.create(
        {
          conversation: conversation.id,
        },
        {
          body: { agent: { name: agent.name, type: "agent_reference" } },
        },
      );

      console.log(`Follow-up: ${followUp.output_text}`);

      // Cleanup
      await openAIClient.conversations.delete(conversation.id);
      await project.agents.deleteVersion(agent.name, agent.version);

  # Code Interpreter Tool
  - name: code_interpreter_tool
    prompt: |
      Create a TypeScript example using the code interpreter tool with
      the AIProjectClient to solve a math problem.
    expected_patterns:
      - 'type: "code_interpreter"'
      - "responses.create"
      - "tools"
    tags:
      - code-interpreter
      - tools
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const deploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());
      const openAIClient = await project.getOpenAIClient();

      const response = await openAIClient.responses.create({
        model: deploymentName,
        input: "I need to solve the equation 3x + 11 = 14. Can you help me?",
        tools: [{ type: "code_interpreter", container: { type: "auto" } }],
      });

      console.log(`Response: ${response.output_text}`);

  # File Search Tool with Vector Store
  - name: file_search_with_vector_store
    prompt: |
      Create a TypeScript example that creates a vector store, uploads a file,
      and creates an agent with file search capability.
    expected_patterns:
      - "vectorStores.create"
      - "vectorStores.files.uploadAndPoll"
      - 'type: "file_search"'
      - "vector_store_ids"
    tags:
      - file-search
      - vector-store
      - tools
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";
      import * as fs from "fs";
      import * as path from "path";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const deploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());
      const openAIClient = await project.getOpenAIClient();

      // Create vector store
      const vectorStore = await openAIClient.vectorStores.create({
        name: "ProductInfoStore",
      });

      // Upload file to vector store
      const assetFilePath = path.join(__dirname, "assets", "product_info.txt");
      const fileStream = fs.createReadStream(assetFilePath);
      const uploadedFile = await openAIClient.vectorStores.files.uploadAndPoll(
        vectorStore.id,
        fileStream,
      );

      console.log(`File uploaded: ${uploadedFile.id}`);

      // Create agent with file search
      const agent = await project.agents.createVersion("FileSearchAgent", {
        kind: "prompt",
        model: deploymentName,
        instructions: "You can search through product information and provide detailed responses.",
        tools: [
          {
            type: "file_search",
            vector_store_ids: [vectorStore.id],
          },
        ],
      });

      console.log(`Created agent: ${agent.id}`);

  # Web Search Tool
  - name: web_search_tool
    prompt: |
      Create a TypeScript example that creates an agent with web search
      capability using the web_search_preview tool.
    expected_patterns:
      - 'type: "web_search_preview"'
      - "user_location"
      - "agents.createVersion"
    tags:
      - web-search
      - tools
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const deploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());
      const openAIClient = await project.getOpenAIClient();

      // Create agent with web search tool
      const agent = await project.agents.createVersion("WebSearchAgent", {
        kind: "prompt",
        model: deploymentName,
        instructions: "You are a helpful assistant that can search the web",
        tools: [
          {
            type: "web_search_preview",
            user_location: {
              type: "approximate",
              country: "US",
              city: "Seattle",
              region: "Washington",
            },
          },
        ],
      });

      // Create conversation
      const conversation = await openAIClient.conversations.create();

      // Send search query
      const response = await openAIClient.responses.create(
        {
          conversation: conversation.id,
          input: "What are the latest Azure AI announcements?",
        },
        {
          body: { agent: { name: agent.name, type: "agent_reference" } },
        },
      );

      console.log(`Response: ${response.output_text}`);

      // Cleanup
      await openAIClient.conversations.delete(conversation.id);
      await project.agents.deleteVersion(agent.name, agent.version);

  # Image Generation Tool
  - name: image_generation_tool
    prompt: |
      Create a TypeScript example that creates an agent with image generation
      capability and downloads the generated image.
    expected_patterns:
      - 'type: "image_generation"'
      - "quality"
      - "size"
      - "base64"
    tags:
      - image-generation
      - tools
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";
      import * as fs from "fs";
      import * as path from "path";
      import { fileURLToPath } from "url";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const deploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());
      const openAIClient = await project.getOpenAIClient();

      // Create agent with image generation
      const agent = await project.agents.createVersion("ImageGenAgent", {
        kind: "prompt",
        model: deploymentName,
        instructions: "Generate images based on user prompts",
        tools: [
          {
            type: "image_generation",
            quality: "low",
            size: "1024x1024",
          },
        ],
      });

      // Generate image
      const response = await openAIClient.responses.create(
        {
          input: "Generate an image of a mountain landscape at sunset.",
        },
        {
          body: { agent: { name: agent.name, type: "agent_reference" } },
        },
      );

      // Download generated image
      const imageData = response.output?.filter((output: any) => output.type === "image_generation_call");
      if (imageData && imageData.length > 0 && imageData[0].result) {
        const __filename = fileURLToPath(import.meta.url);
        const __dirname = path.dirname(__filename);
        const filePath = path.join(__dirname, "generated_image.png");

        const imageBuffer = Buffer.from(imageData[0].result, "base64");
        fs.writeFileSync(filePath, imageBuffer);
        console.log(`Image saved to: ${filePath}`);
      }

      // Cleanup
      await project.agents.deleteVersion(agent.name, agent.version);

  # Multi-turn Conversation with Previous Response
  - name: multi_turn_conversation
    prompt: |
      Create a TypeScript example that demonstrates multi-turn conversation
      using previous_response_id for context continuity.
    expected_patterns:
      - "previous_response_id"
      - "responses.create"
      - "response.id"
    tags:
      - conversations
      - multi-turn
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const deploymentName = process.env.MODEL_DEPLOYMENT_NAME || "gpt-4o";

      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());
      const openAIClient = await project.getOpenAIClient();

      // First message
      const response1 = await openAIClient.responses.create({
        model: deploymentName,
        input: "What is the population of France?",
      });

      console.log(`Response 1: ${response1.output_text}`);

      // Follow-up using previous_response_id
      const response2 = await openAIClient.responses.create({
        model: deploymentName,
        input: "And what about Germany?",
        previous_response_id: response1.id,
      });

      console.log(`Response 2: ${response2.output_text}`);

      // Another follow-up
      const response3 = await openAIClient.responses.create({
        model: deploymentName,
        input: "Which one is larger by area?",
        previous_response_id: response2.id,
      });

      console.log(`Response 3: ${response3.output_text}`);

  # List Connections
  - name: list_connections
    prompt: |
      Create a TypeScript example that lists all connections in a
      project and displays their names and types.
    expected_patterns:
      - "connections.list"
      - "for await"
      - "connection.name"
      - "connection.type"
    tags:
      - connections
      - management
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());

      const connections = await project.connections.list();

      for await (const connection of connections) {
        console.log(`Connection: ${connection.name} (${connection.type})`);
      }

  # List Deployments
  - name: list_deployments
    prompt: |
      Create a TypeScript example that lists all model deployments
      available in a project.
    expected_patterns:
      - "deployments.list"
      - "for await"
      - "deployment.name"
    tags:
      - deployments
      - management
    mock_response: |
      import { AIProjectClient } from "@azure/ai-projects";
      import { DefaultAzureCredential } from "@azure/identity";

      const projectEndpoint = process.env.AZURE_AI_PROJECT_ENDPOINT!;
      const project = new AIProjectClient(projectEndpoint, new DefaultAzureCredential());

      const deployments = await project.deployments.list();

      console.log("Available model deployments:");
      for await (const deployment of deployments) {
        console.log(`  - ${deployment.name}`);
      }
