# yaml-language-server: $schema=https://json.schemastore.org/any.json
# Test scenarios for azure-monitor-query-java skill evaluation

config:
  model: gpt-4
  max_tokens: 2000
  temperature: 0.3

scenarios:
  - name: logs_client_creation
    prompt: |
      Create Java code to set up the Azure Monitor LogsQueryClient
      using DefaultAzureCredential authentication.
    expected_patterns:
      - "LogsQueryClientBuilder"
      - "DefaultAzureCredentialBuilder"
      - "buildClient"
    tags:
      - basic
      - authentication
    mock_response: |
      import com.azure.monitor.query.LogsQueryClient;
      import com.azure.monitor.query.LogsQueryClientBuilder;
      import com.azure.identity.DefaultAzureCredentialBuilder;

      public class LogsClientSetup {
          public static void main(String[] args) {
              LogsQueryClient logsClient = new LogsQueryClientBuilder()
                  .credential(new DefaultAzureCredentialBuilder().build())
                  .buildClient();
              
              System.out.println("Logs client initialized successfully");
          }
      }

  - name: basic_logs_query
    prompt: |
      Create a Java example that queries Log Analytics workspace
      for Azure Activity logs and prints the results.
    expected_patterns:
      - "queryWorkspace"
      - "LogsQueryResult"
      - "QueryTimeInterval"
      - "getTable"
      - "getRows"
      - "getColumnValue"
    tags:
      - logs
      - query
    mock_response: |
      import com.azure.monitor.query.LogsQueryClient;
      import com.azure.monitor.query.LogsQueryClientBuilder;
      import com.azure.monitor.query.models.*;
      import com.azure.identity.DefaultAzureCredentialBuilder;
      import java.time.Duration;

      public class BasicLogsQuery {
          public static void main(String[] args) {
              String workspaceId = System.getenv("LOG_ANALYTICS_WORKSPACE_ID");
              
              LogsQueryClient logsClient = new LogsQueryClientBuilder()
                  .credential(new DefaultAzureCredentialBuilder().build())
                  .buildClient();
              
              LogsQueryResult result = logsClient.queryWorkspace(
                  workspaceId,
                  "AzureActivity | summarize count() by ResourceGroup | top 10 by count_",
                  new QueryTimeInterval(Duration.ofDays(7))
              );
              
              for (LogsTableRow row : result.getTable().getRows()) {
                  System.out.println(row.getColumnValue("ResourceGroup") + ": " + row.getColumnValue("count_"));
              }
          }
      }

  - name: metrics_query
    prompt: |
      Create a Java example that queries metrics for an Azure resource
      using the MetricsQueryClient.
    expected_patterns:
      - "MetricsQueryClient"
      - "MetricsQueryClientBuilder"
      - "queryResource"
      - "MetricsQueryResult"
      - "getMetrics"
      - "getMetricName"
    tags:
      - metrics
      - query
    mock_response: |
      import com.azure.monitor.query.MetricsQueryClient;
      import com.azure.monitor.query.MetricsQueryClientBuilder;
      import com.azure.monitor.query.models.*;
      import com.azure.identity.DefaultAzureCredentialBuilder;
      import java.util.Arrays;

      public class MetricsQuery {
          public static void main(String[] args) {
              String resourceId = System.getenv("AZURE_RESOURCE_ID");
              
              MetricsQueryClient metricsClient = new MetricsQueryClientBuilder()
                  .credential(new DefaultAzureCredentialBuilder().build())
                  .buildClient();
              
              MetricsQueryResult result = metricsClient.queryResource(
                  resourceId,
                  Arrays.asList("SuccessfulCalls", "TotalCalls")
              );
              
              for (MetricResult metric : result.getMetrics()) {
                  System.out.println("Metric: " + metric.getMetricName());
                  for (TimeSeriesElement ts : metric.getTimeSeries()) {
                      for (MetricValue value : ts.getValues()) {
                          System.out.println("  " + value.getTimeStamp() + ": " + value.getTotal());
                      }
                  }
              }
          }
      }

  - name: batch_logs_query
    prompt: |
      Create a Java example that executes multiple log queries
      in a single batch request.
    expected_patterns:
      - "LogsBatchQuery"
      - "addWorkspaceQuery"
      - "queryBatchWithResponse"
      - "LogsBatchQueryResultCollection"
      - "getResult"
    tags:
      - logs
      - batch
    mock_response: |
      import com.azure.monitor.query.LogsQueryClient;
      import com.azure.monitor.query.LogsQueryClientBuilder;
      import com.azure.monitor.query.models.*;
      import com.azure.core.util.Context;
      import com.azure.identity.DefaultAzureCredentialBuilder;
      import java.time.Duration;

      public class BatchLogsQuery {
          public static void main(String[] args) {
              String workspaceId = System.getenv("LOG_ANALYTICS_WORKSPACE_ID");
              
              LogsQueryClient logsClient = new LogsQueryClientBuilder()
                  .credential(new DefaultAzureCredentialBuilder().build())
                  .buildClient();
              
              LogsBatchQuery batchQuery = new LogsBatchQuery();
              String q1 = batchQuery.addWorkspaceQuery(workspaceId, "AzureActivity | count", new QueryTimeInterval(Duration.ofDays(1)));
              String q2 = batchQuery.addWorkspaceQuery(workspaceId, "Heartbeat | count", new QueryTimeInterval(Duration.ofDays(1)));
              String q3 = batchQuery.addWorkspaceQuery(workspaceId, "Perf | count", new QueryTimeInterval(Duration.ofDays(1)));
              
              LogsBatchQueryResultCollection results = logsClient
                  .queryBatchWithResponse(batchQuery, Context.NONE)
                  .getValue();
              
              LogsBatchQueryResult result1 = results.getResult(q1);
              LogsBatchQueryResult result2 = results.getResult(q2);
              LogsBatchQueryResult result3 = results.getResult(q3);
              
              System.out.println("Query 1 status: " + result1.getQueryResultStatus());
              System.out.println("Query 2 status: " + result2.getQueryResultStatus());
              System.out.println("Query 3 status: " + result3.getQueryResultStatus());
          }
      }

  - name: async_logs_client
    prompt: |
      Create a Java example using LogsQueryAsyncClient to query
      Log Analytics workspace asynchronously with Reactor patterns.
    expected_patterns:
      - "LogsQueryAsyncClient"
      - "buildAsyncClient"
      - "\\.subscribe\\("
    forbidden_patterns:
      - "\\.block\\(\\)"
    tags:
      - async
      - logs
    mock_response: |
      import com.azure.monitor.query.LogsQueryAsyncClient;
      import com.azure.monitor.query.LogsQueryClientBuilder;
      import com.azure.monitor.query.models.QueryTimeInterval;
      import com.azure.identity.DefaultAzureCredentialBuilder;
      import java.time.Duration;

      public class AsyncLogsQuery {
          public static void main(String[] args) throws InterruptedException {
              String workspaceId = System.getenv("LOG_ANALYTICS_WORKSPACE_ID");
              
              LogsQueryAsyncClient logsAsyncClient = new LogsQueryClientBuilder()
                  .credential(new DefaultAzureCredentialBuilder().build())
                  .buildAsyncClient();
              
              logsAsyncClient.queryWorkspace(
                  workspaceId,
                  "AzureActivity | summarize count() by ResourceGroup | top 5 by count_",
                  new QueryTimeInterval(Duration.ofDays(1))
              ).subscribe(
                  result -> {
                      System.out.println("Query completed successfully");
                      result.getTable().getRows().forEach(row -> {
                          System.out.println(row.getColumnValue("ResourceGroup") + ": " + row.getColumnValue("count_"));
                      });
                  },
                  error -> System.err.println("Query failed: " + error.getMessage())
              );
              
              // Keep main thread alive for async operation
              Thread.sleep(10000);
          }
      }

  - name: query_with_options
    prompt: |
      Create a Java example that queries logs with LogsQueryOptions
      including server timeout, statistics, and visualization settings.
    expected_patterns:
      - "LogsQueryOptions"
      - "setServerTimeout"
      - "setIncludeStatistics"
      - "setIncludeVisualization"
      - "queryWorkspaceWithResponse"
    tags:
      - logs
      - options
    mock_response: |
      import com.azure.monitor.query.LogsQueryClient;
      import com.azure.monitor.query.LogsQueryClientBuilder;
      import com.azure.monitor.query.models.LogsQueryOptions;
      import com.azure.monitor.query.models.LogsQueryResult;
      import com.azure.monitor.query.models.QueryTimeInterval;
      import com.azure.core.http.rest.Response;
      import com.azure.core.util.BinaryData;
      import com.azure.core.util.Context;
      import com.azure.identity.DefaultAzureCredentialBuilder;
      import java.time.Duration;

      public class LogsQueryWithOptions {
          public static void main(String[] args) {
              String workspaceId = System.getenv("LOG_ANALYTICS_WORKSPACE_ID");
              
              LogsQueryClient logsClient = new LogsQueryClientBuilder()
                  .credential(new DefaultAzureCredentialBuilder().build())
                  .buildClient();
              
              LogsQueryOptions options = new LogsQueryOptions()
                  .setServerTimeout(Duration.ofMinutes(10))
                  .setIncludeStatistics(true)
                  .setIncludeVisualization(true);
              
              Response<LogsQueryResult> response = logsClient.queryWorkspaceWithResponse(
                  workspaceId,
                  "AzureActivity | summarize count() by bin(TimeGenerated, 1h) | render timechart",
                  new QueryTimeInterval(Duration.ofDays(7)),
                  options,
                  Context.NONE
              );
              
              LogsQueryResult result = response.getValue();
              System.out.println("HTTP Status: " + response.getStatusCode());
              
              // Access statistics
              BinaryData statistics = result.getStatistics();
              if (statistics != null) {
                  System.out.println("Statistics: " + statistics.toString());
              }
              
              // Access visualization data
              BinaryData visualization = result.getVisualization();
              if (visualization != null) {
                  System.out.println("Visualization: " + visualization.toString());
              }
          }
      }

  - name: model_mapping
    prompt: |
      Create a Java example that queries logs and maps the results
      to a custom model class using the generic queryWorkspace method.
    expected_patterns:
      - "queryWorkspace.*\\.class"
      - "List<"
      - "get.*\\(\\)"
    tags:
      - logs
      - model
    mock_response: |
      import com.azure.monitor.query.LogsQueryClient;
      import com.azure.monitor.query.LogsQueryClientBuilder;
      import com.azure.monitor.query.models.QueryTimeInterval;
      import com.azure.identity.DefaultAzureCredentialBuilder;
      import java.time.Duration;
      import java.util.List;

      public class LogsModelMapping {
          public static void main(String[] args) {
              String workspaceId = System.getenv("LOG_ANALYTICS_WORKSPACE_ID");
              
              LogsQueryClient logsClient = new LogsQueryClientBuilder()
                  .credential(new DefaultAzureCredentialBuilder().build())
                  .buildClient();
              
              // Query with model mapping
              List<ActivityLog> logs = logsClient.queryWorkspace(
                  workspaceId,
                  "AzureActivity | project ResourceGroup, OperationName, ActivityStatus | take 100",
                  new QueryTimeInterval(Duration.ofDays(2)),
                  ActivityLog.class
              );
              
              for (ActivityLog log : logs) {
                  System.out.println(log.getOperationName() + " - " + log.getResourceGroup() + " - " + log.getActivityStatus());
              }
          }
          
          // Model class matching query projection
          public static class ActivityLog {
              private String resourceGroup;
              private String operationName;
              private String activityStatus;
              
              public String getResourceGroup() { return resourceGroup; }
              public String getOperationName() { return operationName; }
              public String getActivityStatus() { return activityStatus; }
          }
      }

  - name: metrics_with_aggregations
    prompt: |
      Create a Java example that queries metrics with MetricsQueryOptions
      specifying granularity and aggregation types like AVERAGE and COUNT.
    expected_patterns:
      - "MetricsQueryOptions"
      - "setGranularity"
      - "setAggregations"
      - "AggregationType"
      - "queryResourceWithResponse"
    tags:
      - metrics
      - options
    mock_response: |
      import com.azure.monitor.query.MetricsQueryClient;
      import com.azure.monitor.query.MetricsQueryClientBuilder;
      import com.azure.monitor.query.models.MetricsQueryOptions;
      import com.azure.monitor.query.models.MetricsQueryResult;
      import com.azure.monitor.query.models.MetricResult;
      import com.azure.monitor.query.models.AggregationType;
      import com.azure.monitor.query.models.TimeSeriesElement;
      import com.azure.monitor.query.models.MetricValue;
      import com.azure.core.http.rest.Response;
      import com.azure.core.util.Context;
      import com.azure.identity.DefaultAzureCredentialBuilder;
      import java.time.Duration;
      import java.util.Arrays;

      public class MetricsWithAggregations {
          public static void main(String[] args) {
              String resourceId = System.getenv("AZURE_RESOURCE_ID");
              
              MetricsQueryClient metricsClient = new MetricsQueryClientBuilder()
                  .credential(new DefaultAzureCredentialBuilder().build())
                  .buildClient();
              
              Response<MetricsQueryResult> response = metricsClient.queryResourceWithResponse(
                  resourceId,
                  Arrays.asList("SuccessfulCalls", "TotalCalls", "TotalErrors"),
                  new MetricsQueryOptions()
                      .setGranularity(Duration.ofHours(1))
                      .setAggregations(Arrays.asList(AggregationType.AVERAGE, AggregationType.COUNT, AggregationType.TOTAL)),
                  Context.NONE
              );
              
              MetricsQueryResult result = response.getValue();
              System.out.println("Granularity: " + result.getGranularity());
              System.out.println("Time Interval: " + result.getTimeInterval());
              
              for (MetricResult metric : result.getMetrics()) {
                  System.out.println("\nMetric: " + metric.getMetricName() + " (" + metric.getUnit() + ")");
                  for (TimeSeriesElement ts : metric.getTimeSeries()) {
                      for (MetricValue value : ts.getValues()) {
                          System.out.printf("  %s: Avg=%.2f, Count=%.0f, Total=%.2f%n",
                              value.getTimeStamp(),
                              value.getAverage(),
                              value.getCount(),
                              value.getTotal());
                      }
                  }
              }
          }
      }
