# Test scenarios for azure-ai-agents-py skill evaluation
# Each scenario tests a specific usage pattern against acceptance criteria

config:
  model: gpt-4
  max_tokens: 2000
  temperature: 0.3

scenarios:
  # Basic Agent Creation
  - name: basic_agent_creation
    prompt: |
      Create a basic Azure AI agent that can respond to user messages.
      Include proper authentication, agent creation, thread management,
      and cleanup.
    expected_patterns:
      - "DefaultAzureCredential"
      - "create_agent"
      - "threads.create"
      - "messages.create"
      - "delete_agent"
    forbidden_patterns:
      - "openai.OpenAI"  # Should use Azure SDK, not OpenAI directly
    tags:
      - basic
      - authentication
    mock_response: |
      import os
      from azure.identity import DefaultAzureCredential
      from azure.ai.agents import AgentsClient
      
      client = AgentsClient(
          endpoint=os.environ["PROJECT_ENDPOINT"],
          credential=DefaultAzureCredential(),
      )
      
      agent = client.create_agent(
          model=os.environ["MODEL_DEPLOYMENT_NAME"],
          name="my-agent",
          instructions="You are a helpful assistant.",
      )
      
      thread = client.threads.create()
      
      client.messages.create(
          thread_id=thread.id,
          role="user",
          content="Hello!",
      )
      
      run = client.runs.create_and_process(
          thread_id=thread.id,
          agent_id=agent.id
      )
      
      if run.status == "completed":
          messages = client.messages.list(thread_id=thread.id)
          for msg in messages:
              if msg.role == "assistant":
                  print(msg.content[0].text.value)
      
      client.delete_agent(agent.id)

  # Function Calling with FunctionTool
  - name: function_tool_usage
    prompt: |
      Create an agent with a custom function tool that can get weather 
      information. Use FunctionTool with proper function definitions
      and automatic function calling.
    expected_patterns:
      - "FunctionTool"
      - "ToolSet"
      - "functions="
      - "toolset"
    forbidden_patterns:
      - "tools=[get_weather]"  # Functions go in FunctionTool, not directly in tools
    tags:
      - function-calling
      - tools
    mock_response: |
      import os
      from azure.identity import DefaultAzureCredential
      from azure.ai.agents import AgentsClient
      from azure.ai.agents.models import FunctionTool, ToolSet
      
      def get_weather(location: str) -> str:
          """Get the weather for a location.
          
          Args:
              location: The city name to get weather for.
          
          Returns:
              Weather description for the location.
          """
          return f"Weather in {location}: 72Â°F, sunny"
      
      client = AgentsClient(
          endpoint=os.environ["PROJECT_ENDPOINT"],
          credential=DefaultAzureCredential(),
      )
      
      functions = FunctionTool(functions=[get_weather])
      toolset = ToolSet()
      toolset.add(functions)
      
      agent = client.create_agent(
          model=os.environ["MODEL_DEPLOYMENT_NAME"],
          name="weather-agent",
          instructions="Help users with weather information.",
          toolset=toolset,
      )
      
      thread = client.threads.create()
      
      client.messages.create(
          thread_id=thread.id,
          role="user",
          content="What's the weather in Seattle?",
      )
      
      run = client.runs.create_and_process(
          thread_id=thread.id,
          agent_id=agent.id,
          toolset=toolset,  # Pass toolset for auto-execution
      )
      
      if run.status == "completed":
          messages = client.messages.list(thread_id=thread.id)
          last_msg = messages.data[0]
          if last_msg.role == "assistant":
              print(last_msg.content[0].text.value)
      
      client.delete_agent(agent.id)

  # Code Interpreter Tool
  - name: code_interpreter_tool
    prompt: |
      Create an agent with code interpreter capability that can 
      execute Python code and analyze data files.
    expected_patterns:
      - "CodeInterpreterTool"
      - "tool_resources"
      - "code_interpreter"
    forbidden_patterns:
      - 'tools=["code_interpreter"]'  # Should use CodeInterpreterTool class
    tags:
      - code-interpreter
      - tools
    mock_response: |
      import os
      from azure.identity import DefaultAzureCredential
      from azure.ai.agents import AgentsClient
      from azure.ai.agents.models import CodeInterpreterTool
      
      client = AgentsClient(
          endpoint=os.environ["PROJECT_ENDPOINT"],
          credential=DefaultAzureCredential(),
      )
      
      # Upload file for code interpreter
      file = client.files.upload_and_poll(
          file_path="data.csv",
          purpose="assistants",
      )
      
      agent = client.create_agent(
          model=os.environ["MODEL_DEPLOYMENT_NAME"],
          name="data-analyst",
          instructions="Analyze data and create visualizations.",
          tools=[CodeInterpreterTool()],
          tool_resources={"code_interpreter": {"file_ids": [file.id]}},
      )
      
      thread = client.threads.create()
      
      client.messages.create(
          thread_id=thread.id,
          role="user",
          content="Analyze the CSV file and create a summary.",
      )
      
      run = client.runs.create_and_process(
          thread_id=thread.id,
          agent_id=agent.id
      )
      
      client.delete_agent(agent.id)

  # Streaming with Event Handler
  - name: streaming_event_handler
    prompt: |
      Create an agent that uses streaming responses with an event handler
      to process real-time message deltas.
    expected_patterns:
      - "AgentEventHandler"
      - "on_message_delta"
      - "runs.stream"
      - "until_done"
    forbidden_patterns:
      - "stream=True"  # Old pattern, should use event handler
    tags:
      - streaming
      - advanced
    mock_response: |
      import os
      from azure.identity import DefaultAzureCredential
      from azure.ai.agents import AgentsClient
      from azure.ai.agents.models import AgentEventHandler
      
      class MyHandler(AgentEventHandler):
          def on_message_delta(self, delta):
              if delta.text:
                  print(delta.text.value, end="", flush=True)
          
          def on_error(self, data):
              print(f"Error: {data}")
      
      client = AgentsClient(
          endpoint=os.environ["PROJECT_ENDPOINT"],
          credential=DefaultAzureCredential(),
      )
      
      agent = client.create_agent(
          model=os.environ["MODEL_DEPLOYMENT_NAME"],
          name="streaming-agent",
          instructions="You are a helpful assistant.",
      )
      
      thread = client.threads.create()
      
      client.messages.create(
          thread_id=thread.id,
          role="user",
          content="Tell me a story.",
      )
      
      with client.runs.stream(
          thread_id=thread.id,
          agent_id=agent.id,
          event_handler=MyHandler(),
      ) as stream:
          stream.until_done()
      
      client.delete_agent(agent.id)

  # Async Client Usage
  - name: async_client_usage
    prompt: |
      Create an async version of an Azure AI agent using the async client
      with proper context management and await patterns.
    expected_patterns:
      - "from azure.ai.agents.aio import AgentsClient"
      - "async with"
      - "await client.create_agent"
      - "await client.threads.create"
    forbidden_patterns:
      - "from azure.ai.agents import AgentsClient"  # Should use .aio for async
    tags:
      - async
      - advanced
    mock_response: |
      import os
      import asyncio
      from azure.identity.aio import DefaultAzureCredential
      from azure.ai.agents.aio import AgentsClient
      
      async def main():
          credential = DefaultAzureCredential()
          
          async with AgentsClient(
              endpoint=os.environ["PROJECT_ENDPOINT"],
              credential=credential,
          ) as client:
              agent = await client.create_agent(
                  model=os.environ["MODEL_DEPLOYMENT_NAME"],
                  name="async-agent",
                  instructions="You are a helpful assistant.",
              )
              
              thread = await client.threads.create()
              
              await client.messages.create(
                  thread_id=thread.id,
                  role="user",
                  content="Hello!",
              )
              
              run = await client.runs.create_and_process(
                  thread_id=thread.id,
                  agent_id=agent.id
              )
              
              if run.status == "completed":
                  messages = await client.messages.list(thread_id=thread.id)
                  for msg in messages:
                      if msg.role == "assistant":
                          print(msg.content[0].text.value)
              
              await client.delete_agent(agent.id)
      
      asyncio.run(main())

  # File Search with Vector Store
  - name: file_search_vector_store
    prompt: |
      Create an agent with file search capability using a vector store
      for RAG (retrieval augmented generation) over documents.
    expected_patterns:
      - "FileSearchTool"
      - "vector_stores.create_and_poll"
      - "vector_store_ids"
      - "file_search"
    tags:
      - file-search
      - rag
      - tools
    mock_response: |
      import os
      from azure.identity import DefaultAzureCredential
      from azure.ai.agents import AgentsClient
      from azure.ai.agents.models import FileSearchTool
      
      client = AgentsClient(
          endpoint=os.environ["PROJECT_ENDPOINT"],
          credential=DefaultAzureCredential(),
      )
      
      # Upload documents
      file = client.files.upload_and_poll(
          file_path="documentation.pdf",
          purpose="assistants",
      )
      
      # Create vector store
      vector_store = client.vector_stores.create_and_poll(
          file_ids=[file.id],
          name="docs-store",
      )
      
      agent = client.create_agent(
          model=os.environ["MODEL_DEPLOYMENT_NAME"],
          name="rag-agent",
          instructions="Answer questions using the provided documents.",
          tools=[FileSearchTool()],
          tool_resources={
              "file_search": {"vector_store_ids": [vector_store.id]}
          },
      )
      
      thread = client.threads.create()
      
      client.messages.create(
          thread_id=thread.id,
          role="user",
          content="What does the documentation say about authentication?",
      )
      
      run = client.runs.create_and_process(
          thread_id=thread.id,
          agent_id=agent.id
      )
      
      client.delete_agent(agent.id)

  # Azure AI Search Tool
  - name: azure_ai_search_tool
    prompt: |
      Create an agent that uses Azure AI Search to query an existing
      search index for information retrieval.
    expected_patterns:
      - "AzureAISearchTool"
      - "index_name"
    tags:
      - azure-search
      - tools
    mock_response: |
      import os
      from azure.identity import DefaultAzureCredential
      from azure.ai.agents import AgentsClient
      from azure.ai.agents.models import AzureAISearchTool
      
      client = AgentsClient(
          endpoint=os.environ["PROJECT_ENDPOINT"],
          credential=DefaultAzureCredential(),
      )
      
      # Configure Azure AI Search tool
      search_tool = AzureAISearchTool(
          index_connection_id=os.environ["SEARCH_CONNECTION_ID"],
          index_name="products-index",
      )
      
      agent = client.create_agent(
          model=os.environ["MODEL_DEPLOYMENT_NAME"],
          name="search-agent",
          instructions="Help users find products using the search index.",
          tools=[search_tool],
      )
      
      thread = client.threads.create()
      
      client.messages.create(
          thread_id=thread.id,
          role="user",
          content="Find products related to Azure services",
      )
      
      run = client.runs.create_and_process(
          thread_id=thread.id,
          agent_id=agent.id
      )
      
      client.delete_agent(agent.id)

  # Manual Run Polling
  - name: manual_run_polling
    prompt: |
      Create an agent that uses manual run polling instead of 
      create_and_process, showing how to handle run status transitions.
    expected_patterns:
      - "runs.create"
      - "runs.get"
      - 'status == "completed"'
      - "while"
    forbidden_patterns:
      - "create_and_process"  # Should use manual polling
    tags:
      - advanced
      - polling
    mock_response: |
      import os
      import time
      from azure.identity import DefaultAzureCredential
      from azure.ai.agents import AgentsClient
      
      client = AgentsClient(
          endpoint=os.environ["PROJECT_ENDPOINT"],
          credential=DefaultAzureCredential(),
      )
      
      agent = client.create_agent(
          model=os.environ["MODEL_DEPLOYMENT_NAME"],
          name="manual-polling-agent",
          instructions="You are a helpful assistant.",
      )
      
      thread = client.threads.create()
      
      client.messages.create(
          thread_id=thread.id,
          role="user",
          content="Hello!",
      )
      
      # Create run without auto-processing
      run = client.runs.create(
          thread_id=thread.id,
          agent_id=agent.id
      )
      
      # Manual polling
      while run.status in ["queued", "in_progress", "requires_action"]:
          time.sleep(1)
          run = client.runs.get(thread_id=thread.id, run_id=run.id)
      
      if run.status == "completed":
          messages = client.messages.list(thread_id=thread.id)
          for msg in messages:
              if msg.role == "assistant":
                  print(msg.content[0].text.value)
      elif run.status == "failed":
          print(f"Run failed: {run.last_error}")
      
      client.delete_agent(agent.id)
